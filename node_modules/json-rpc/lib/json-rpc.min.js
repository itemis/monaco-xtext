var util=require("util");var through=require("through");var checkParam=function(a,c,d,b){if(c===undefined){if(d){throw Error("no "+a+" given");}else{return;
}}if(b=="int"){if(c!==parseInt(c)){throw Error(a+" must be an integer");}}else{if(b=="array"){if(!(c instanceof Array)){throw Error(a+" must be an array");
}}}};var specs=module.exports.specs={errors:{"-32700":"Parse error","-32600":"Invalid Request","-32601":"Method not found","-32602":"Invalid params","-32603":"Internal error","-32000":"Server error"},request:function(e,d,c,b){checkParam("method",e,true);
checkParam("id",d,false,"int");var a=util.format('{"jsonrpc":"2.0","method":"%s"',e);if(d!=null){a+=',"id":'+d;}if(c!=null){a+=',"params":'+(!b?JSON.stringify(c):c);
}return a+"}";},response:function(d,a,c){checkParam("id",d,true,"int");checkParam("result",a,true);var b='{"jsonrpc":"2.0","id":%s,"result":%s}';return util.format(b,d,(!c?JSON.stringify(a):a));
},error:function(g,d,c,e,f){checkParam("id",g,true,"int");checkParam("code",d,true,"int");checkParam("message",c,true);var a='{"jsonrpc":"2.0","id":%s,"error":{"code":%s,"message":"%s"';
var b=util.format(a,g,d,c);if(e!=null){b+=',"data":'+(!f?JSON.stringify(e):e);}return b+"}}";}};var rpc=module.exports.rpc=function(f){var i,g={},a=0;var e=function(k){if(k.id&&g[k.id]){g[k.id].apply(null,[null].concat(k.result));
delete g[k.id];}};var c=function(k){if(k.id&&g[k.id]){var m=util.format("%s (%s)",k.error.message,k.error.code);var l=new Error(m);l.code=k.error.code;
l.data=k.error.data;g[k.id](l);delete g[k.id];}};var h=function(l){if(!f){return;}try{var m=function(o){if(o){throw o;}var n=Array.prototype.slice.call(arguments,1);
if(l.id){i.emit("data",specs.response(l.id,n)+"\n");}};j(l.method,l.params,m);}catch(k){if(l.id){k=specs.error(l.id,k.code,k.message,k.data);i.emit("data",k+"\n");
}}};var j=function(l,q,r){try{var k=f;var p=l.split(".");while(p.length>1){var m=p.shift();if(k[m]){k=k[m];}else{break;}}var n=k[p[0]];if(!(n instanceof Function)){throw {code:-32601,message:specs.errors["-32601"],data:null};
}else{q=q||[];q.push(r);n.apply(k,q);}}catch(o){throw {code:-32603,message:specs.errors["-32603"],data:null};}};i=through(function(k){k=JSON.parse(String(k));
if("method" in k){h(k);}else{if("result" in k){e(k);}else{if("error" in k){c(k);}}}});var d=function(k,n,p,m){if(n instanceof Function){encdoded=p;p=n;
n=null;}checkParam("params",n||undefined,false,"array");if(p instanceof Function){g[++a]=p;}var o=(p instanceof Function)?a:undefined;var l=specs.request(k,o,n,m);
i.emit("data",l+"\n");if(p&&a==Number.MAX_VALUE){a=0;}return i;};var b=function(k,l){if(l===undefined){l=k;k=null;}checkParam("keys",l,true,"array");wrapper={};
l.forEach(function(m){wrapper[m]=function(){var o=Array.prototype.slice.call(arguments);var n=null;if(o[o.length-1] instanceof Function){n=o.pop();}if(k){m=k+"."+m;
}d(m,o,n);return this;};});return wrapper;};i.invoke=d;i.wrap=b;return i;};